# 1. Ð’ Ð´Ð°Ð½Ð½Ð¾Ð¼ Ñ€ÑƒÐºÐ¾Ð²Ð¾Ð´ÑÑ‚Ð²Ðµ Ð´Ð»Ñ Ð¿Ð¾Ð»ÑƒÑ‡ÐµÐ½Ð¸Ñ Ð¿Ð¾Ð³Ð¾Ð´Ñ‹ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÑ‚ÑÑ ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð½Ñ‹Ð¹ ÐºÐ»Ð¸ÐµÐ½Ñ‚. Ð¡Ð¾Ð¾Ñ‚Ð²ÐµÑ‚ÑÑ‚Ð²ÐµÐ½Ð½Ð¾,
# Ð¿Ð¾ÐºÐ° Ð±Ð¾Ñ‚ Ð¶Ð´Ñ‘Ñ‚ Ð¾Ñ‚Ð²ÐµÑ‚Ð° Ð¾Ñ‚ ÑÐµÑ€Ð²Ð¸ÑÐ° Ð¿Ð¾Ð³Ð¾Ð´Ñ‹, Ð°ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð½Ð¾Ðµ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ð‘Ð›ÐžÐšÐ˜Ð Ð£Ð•Ð¢Ð¡Ð¯ Ð¸ Ð½Ðµ Ð¾Ð±Ñ€Ð°Ð±Ð°Ñ‚Ñ‹Ð²Ð°ÐµÑ‚
# Ð´Ñ€ÑƒÐ³Ð¸Ðµ ÑÐ¾Ð¾Ð±Ñ‰ÐµÐ½Ð¸Ñ. Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ Ð°ÑÐ¸Ð½Ñ…Ñ€Ð¾Ð½Ð½Ñ‹Ð¹ ÐºÐ»Ð¸ÐµÐ½Ñ‚ Ð´Ð»Ñ Ð¸Ð·Ð±ÐµÐ¶Ð°Ð½Ð¸Ñ Ð±Ð»Ð¾ÐºÐ¸Ñ€Ð¾Ð²Ð¾Ðº. Ð’ aiogram Ð¼Ñ‹ Ð¸ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐµÐ¼ aiohttp.
#
# 2. Ð—Ð°Ð¿Ñ€Ð¾ÑÑ‹ Ðº API Ð»ÑƒÑ‡ÑˆÐµ ÐºÑÑˆÐ¸Ñ€Ð¾Ð²Ð°Ñ‚ÑŒ. Ð•ÑÐ»Ð¸ Ñƒ Ð²Ð°Ñ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ Ð´Ñ‘Ñ€Ð³Ð°ÐµÑ‚ Ð¿Ð¾Ð³Ð¾Ð´Ñƒ 30 Ñ€Ð°Ð· Ð² ÑÐµÐºÑƒÐ½Ð´Ñƒ,
# Ñ‚Ð¾ Ð½Ð°Ð³Ñ€ÑƒÐ¶Ð°Ñ‚ÑŒ API Ð½Ðµ Ð¸Ð¼ÐµÐµÑ‚ ÑÐ¼Ñ‹ÑÐ»Ð°, Ð¿Ñ€Ð¾ÑÑ‚Ð¾ Ð¾Ñ‚Ð´Ð°Ð¹Ñ‚Ðµ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŽ Ð¿Ñ€ÐµÐ´Ñ‹Ð´ÑƒÑ‰Ð¸Ð¹ Ñ€ÐµÐ·ÑƒÐ»ÑŒÑ‚Ð°Ñ‚.
#
# 3. Ð¡ÐµÑ€Ð²Ð¸Ñ Ð¿Ð¾Ð³Ð¾Ð´Ñ‹ Ð¼Ð¾Ð¶ÐµÑ‚ Ð±Ñ‹Ñ‚ÑŒ Ð²Ñ€ÐµÐ¼ÐµÐ½Ð½Ð¾ Ð½ÐµÐ´Ð¾ÑÑ‚ÑƒÐ¿ÐµÐ½ Ð¸ Ð²Ð°ÑˆÐµ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶ÐµÐ½Ð¸Ðµ Ðº ÑÑ‚Ð¾Ð¼Ñƒ Ð½Ðµ Ð³Ð¾Ñ‚Ð¾Ð²Ð¾.
# Ð˜ÑÐ¿Ð¾Ð»ÑŒÐ·ÑƒÐ¹Ñ‚Ðµ backoff Ð¸ Ð´Ð¾Ð¿Ð¸ÑˆÐ¸Ñ‚Ðµ ÑÑ†ÐµÐ½Ð°Ñ€Ð¸Ð¹ Ð¾Ñ‚ÐºÐ°Ð·Ð° Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŽ.
#
# 4. Ð’ aiogram Ð¼Ñ‹ Ð´Ð¾Ð±Ð°Ð²Ð¸Ð»Ð¸ Ð¼Ð½Ð¾Ð³Ð¾ ÑƒÐ´Ð¾Ð±Ð½Ñ‹Ñ… ÑˆÐ¾Ñ€Ñ‚ÐºÐ°Ñ‚Ð¾Ð², Ð½Ð°Ð¿Ñ€Ð¸Ð¼ÐµÑ€ Ð¾Ñ‚Ð²ÐµÑ‡Ð°Ñ‚ÑŒ Ð½Ð° callback query Ð¼Ð¾Ð¶Ð½Ð¾ Ñ‚Ð°Ðº: callback_query.answer()
#
# 5. Ð”ÐµÑ€Ð¶Ð°Ñ‚ÑŒ config.py Ð² Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¸ - Ð½Ðµ Ð¾Ñ‡ÐµÐ½ÑŒ Ñ…Ð¾Ñ€Ð¾ÑˆÐ°Ñ Ð¿Ñ€Ð°ÐºÑ‚Ð¸ÐºÐ°. Ð•ÑÐ»Ð¸ Ñ…Ð¾Ñ‡ÐµÑ‚ÑÑ Ð¸Ð¼ÐµÐ½Ð½Ð¾ Ñ‚Ð°ÐºÐ¾Ð¹ Ñ„Ð¾Ñ€Ð¼Ð°Ñ‚ ÐºÐ¾Ð½Ñ„Ð¸Ð³ÑƒÑ€Ð°Ñ†Ð¸Ð¸ Ð¾ÑÑ‚Ð°Ð²Ð¸Ñ‚ÑŒ,
# Ñ‚Ð¾ Ð² Ñ€ÐµÐ¿Ð¾Ð·Ð¸Ñ‚Ð¾Ñ€Ð¸Ð¹ Ð¿Ñ€Ð¸Ð»Ð¾Ð¶Ð¸Ñ‚Ðµ Ð¿Ñ€Ð¸Ð¼ÐµÑ€ (Ñ Ð´Ñ€ÑƒÐ³Ð¸Ð¼ Ð¸Ð¼ÐµÐ½ÐµÐ¼), Ð° Ð²Ð°Ñˆ Ð¿Ð¾Ð»ÑŒÐ·Ð¾Ð²Ð°Ñ‚ÐµÐ»ÑŒ ÑƒÐ¶Ðµ ÑÐºÐ¾Ð¿Ð¸Ñ€ÑƒÐµÑ‚ ÐµÐ³Ð¾ Ð² config.py.
# Ð¡Ð°Ð¼ config.py Ð´Ð¾Ð±Ð°Ð²ÑŒÑ‚Ðµ Ð² ignore, Ñ‡Ñ‚Ð¾Ð±Ñ‹ Ð¾Ð½ Ð½Ðµ Ð¿Ð¾Ð¿Ð°Ð´Ð°Ð» Ð² git.


import json
from dataclasses import dataclass
# from datetime import datetime
from enum import IntEnum
# from typing import TypeAlias # Ð½Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ð½Ð° python 8
from urllib.request import urlopen

import config
from coordinates import Coordinates, CoordinatesR, CoordinatesN, CoordinatesP


# Celsius: TypeAlias = float # Ð½Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ð½Ð° python 8


class WindDirection(IntEnum):
    North = 0
    Northeast = 45
    East = 90
    Southeast = 135
    South = 180
    Southwest = 225
    West = 270
    Northwest = 315


# @dataclass(slots=True, frozen=True) # Ð½Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ð½Ð° python 8
@dataclass()
class Weather:
    location: str
    temperature: float  # Celsius # Ð½Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ð½Ð° python 8
    temperature_feeling: float  # Celsius # Ð½Ðµ Ñ€Ð°Ð±Ð¾Ñ‚Ð°ÐµÑ‚ Ð½Ð° python 8
    description: str
    wind_speed: float
    wind_direction: str
    # sunrise: datetime
    # sunset: datetime


def get_weather(coordinates=Coordinates):
    """Requests the weather in OpenWeather API and returns it"""
    openweather_response = _get_open_weather_response(longitude=coordinates.longitude, latitude=coordinates.latitude)
    weather = _parse_openweather_response(openweather_response)
    return weather


def _get_open_weather_response(latitude: float, longitude: float):
    url = config.CURRENT_WEATHER_API_CALL.format(latitude=latitude, longitude=longitude)
    return urlopen(url).read()


def _parse_openweather_response(openweather_response: str):
    openweather_dict = json.loads(openweather_response)
    return Weather(
        location=_parse_location(openweather_dict),
        temperature=_parse_temperature(openweather_dict),
        temperature_feeling=_parse_temperature_feeling(openweather_dict),
        description=_parse_description(openweather_dict),
        wind_speed=_parse_wind_speed(openweather_dict),
        wind_direction=_parse_wind_direction(openweather_dict)
    )


def _parse_location(openweather_dict: dict):
    return openweather_dict['name']


def _parse_temperature(openweather_dict: dict):
    return openweather_dict['main']['temp']


def _parse_temperature_feeling(openweather_dict: dict):
    return openweather_dict['main']['feels_like']


def _parse_description(openweather_dict: dict):
    return str(openweather_dict['weather'][0]['description']).capitalize()


def _parse_wind_speed(openweather_dict: dict):
    return openweather_dict['wind']['speed']


def _parse_wind_direction(openweather_dict: dict) -> str:
    degrees = openweather_dict['wind']['deg']
    degrees = round(degrees / 45) * 45
    if degrees == 360:
        degrees = 0
    return WindDirection(degrees).name



str_weather_global: str = ''
@dataclass()
class StrWeather:
    str_weather: str = ''


class GetWeather:

    def __init__(self):
        self.weather_r()
        self.weather_n()
        self.weather_p()
        self.str_weather = ''

    def weather_r(self):
        """Returns a message about the temperature and weather description"""
        wthr = get_weather(coordinates=CoordinatesR)
        return f'{wthr.location}, {wthr.description}\n' \
               f'Temp: {wthr.temperature}Â°C, feels like: {wthr.temperature_feeling}Â°C\n' \
               f'Wind: {wthr.wind_direction}, {wthr.wind_speed} m/s'

    def weather_n(self):
        """Returns a message about the temperature and weather description"""
        wthr = get_weather(coordinates=CoordinatesN)
        return f'{wthr.location}, {wthr.description}\n' \
               f'Temp: {wthr.temperature}Â°C, feels like: {wthr.temperature_feeling}Â°C\n' \
               f'Wind: {wthr.wind_direction}, {wthr.wind_speed} m/s'

    def weather_p(self):
        """Returns a message about the temperature and weather description"""
        wthr = get_weather(coordinates=CoordinatesP)
        return f'{wthr.location}(ÐŸÐ¸Ñ‚ÐµÑ€ Ð¿Ð¾Ð¹Ð¼ÐµÑ‚ ðŸ˜‰), {wthr.description}\n' \
               f'Temp: {wthr.temperature}Â°C, feels like: {wthr.temperature_feeling}Â°C\n' \
               f'Wind: {wthr.wind_direction}, {wthr.wind_speed} m/s'

    def weather(self):
        self.str_weather = f'{self.weather_r()}\n\n{self.weather_n()}\n\n{self.weather_p()}\n'
        StrWeather(str_weather=self.str_weather)
        str_weather_global = self.str_weather
        return self.str_weather
